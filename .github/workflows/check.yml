name: Check

on:
    push:
        branches: [main, lean]
    pull_request:

jobs:
    check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: samueldr/lix-gha-installer-action@v2026-02-16

            - name: Assert Lix runtime
              run: |
                  nix --version
                  nix --version | grep -q "Lix"

            - name: Evaluate darwin configuration
              run: nix eval .#darwinConfigurations.trfmbp.system --raw

            - name: Evaluate nixos configurations
              run: |
                  nix eval .#nixosConfigurations.trfnix.config.system.build.toplevel.drvPath --raw
                  nix eval .#nixosConfigurations.trfwsl.config.system.build.toplevel.drvPath --raw

            - name: Check formatting
              run: nix build .#checks.$(nix eval --impure --expr builtins.currentSystem --raw).formatting --no-link

    build-trfnix:
        if: github.event_name == 'push'
        needs: check
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: samueldr/lix-gha-installer-action@v2026-02-16

            - uses: cachix/cachix-action@v15
              with:
                  name: tomrfitz
                  extraPullNames: nix-community
                  authToken: ${{ secrets.CACHIX }}

            - name: Build trfnix system closure
              run: nix build .#nixosConfigurations.trfnix.config.system.build.toplevel --no-link
